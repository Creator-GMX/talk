<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkHub - Plataforma de Comunicação</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#06b6d4',
                        dark: '#1f2937',
                        darker: '#111827'
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .online-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .video-call-overlay {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.8);
        }
        
        .floating-btn {
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
            transition: all 0.3s ease;
        }
        
        .floating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
        }
        
        .typing-indicator {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        .file-preview {
            max-width: 300px;
            max-height: 200px;
            object-fit: cover;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .connected {
            background: #10b981;
            color: white;
        }
        
        .disconnected {
            background: #ef4444;
            color: white;
        }
        
        .reconnecting {
            background: #f59e0b;
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-violet-900 min-h-screen">
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status connected hidden">
        Conectado
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">TalkHub</h1>
                <p class="text-gray-300">Conecte-se com o mundo</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="usernameInput" placeholder="Nome de usuário" 
                       class="w-full p-4 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/50">
                <input type="email" id="emailInput" placeholder="E-mail" 
                       class="w-full p-4 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/50">
                <button onclick="login()" class="w-full p-4 bg-gradient-to-r from-primary to-secondary rounded-xl text-white font-semibold hover:from-primary/80 hover:to-secondary/80 transition-all">
                    Entrar
                </button>
                <button onclick="toggleRegisterMode()" id="registerToggle" class="w-full p-3 border border-white/30 rounded-xl text-gray-300 hover:bg-white/10 transition-all">
                    Criar Conta
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Sidebar -->
        <div class="fixed left-0 top-0 h-full w-80 glass-effect z-10 overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b border-white/10">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center cursor-pointer" onclick="showProfileModal()">
                            <img id="userAvatar" src="" alt="Avatar do usuário" class="w-full h-full rounded-full object-cover hidden"/ src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/48296434-3372-41d4-b638-d712f94e3979.png">
                            <span class="text-white font-bold text-lg" id="userInitials">U</span>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold" id="currentUserName">Usuário</h3>
                            <p class="text-green-400 text-sm flex items-center">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-2 online-indicator"></span>
                                Online
                            </p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="toggleNotifications()" id="notificationToggle" class="p-2 hover:bg-white/10 rounded-lg transition-all">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                            </svg>
                        </button>
                        <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-lg transition-all">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        <button onclick="logout()" class="p-2 hover:bg-white/10 rounded-lg transition-all">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-white/10">
                <button onclick="showTab('chats')" class="tab-btn flex-1 p-3 text-center text-white bg-primary/20 border-b-2 border-primary">
                    Chats
                </button>
                <button onclick="showTab('groups')" class="tab-btn flex-1 p-3 text-center text-gray-400 hover:text-white transition-all">
                    Grupos
                </button>
                <button onclick="showTab('contacts')" class="tab-btn flex-1 p-3 text-center text-gray-400 hover:text-white transition-all">
                    Contatos
                </button>
            </div>

            <!-- Search -->
            <div class="p-4">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Pesquisar..." 
                           class="w-full p-3 pl-10 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-primary"
                           oninput="searchConversations()">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>

            <!-- Content Lists -->
            <div class="flex-1 overflow-y-auto" id="contentContainer">
                <!-- Chats List -->
                <div id="chatsList" class="p-4 space-y-2">
                    <!-- Chat items will be populated dynamically -->
                </div>

                <!-- Groups List -->
                <div id="groupsList" class="p-4 space-y-2 hidden">
                    <!-- Group items will be populated dynamically -->
                </div>

                <!-- Contacts List -->
                <div id="contactsList" class="p-4 space-y-2 hidden">
                    <!-- Contact items will be populated dynamically -->
                </div>
            </div>

            <!-- Add Button -->
            <div class="p-4 border-t border-white/10">
                <button onclick="showAddModal()" class="w-full p-3 bg-gradient-to-r from-primary to-secondary rounded-xl text-white font-medium hover:from-primary/80 hover:to-secondary/80 transition-all">
                    + Novo Chat
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="ml-80 flex flex-col h-screen">
            <!-- Chat Header -->
            <div id="chatHeader" class="glass-effect p-4 border-b border-white/10 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <img id="chatUserAvatar" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/88c057f7-3c1d-41dc-924b-2a2bcfb94411.png" alt="Avatar do usuário do chat atual" class="w-10 h-10 rounded-full"/>
                        <div>
                            <h3 id="chatUserName" class="text-white font-semibold">Selecione um chat</h3>
                            <p id="chatUserStatus" class="text-sm text-gray-400">Offline</p>
                            <p id="typingIndicator" class="text-sm text-primary typing-indicator hidden">digitando...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="shareScreen()" class="p-3 hover:bg-white/10 rounded-lg transition-all">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/>
                            </svg>
                        </button>
                        <button onclick="startCall(currentChat, 'audio')" class="p-3 hover:bg-white/10 rounded-lg transition-all">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                            </svg>
                        </button>
                        <button onclick="startCall(currentChat, 'video')" class="p-3 hover:bg-white/10 rounded-lg transition-all">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                            </svg>
                        </button>
                        <button onclick="showChatInfo()" class="p-3 hover:bg-white/10 rounded-lg transition-all">
                            <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="w-32 h-32 mx-auto mb-6 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                        <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-white mb-4">Bem-vindo ao TalkHub</h2>
                    <p class="text-gray-400 text-lg">Selecione uma conversa para começar a chatear</p>
                    <p class="text-gray-500 text-sm mt-4">Usuários online: <span id="onlineCount">0</span></p>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
                <!-- Messages will be populated here -->
            </div>

            <!-- Message Input -->
            <div id="messageInput" class="glass-effect p-4 border-t border-white/10 hidden">
                <div class="flex items-center space-x-3">
                    <input type="file" id="fileInput" multiple accept="*/*" class="hidden" onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('fileInput').click()" class="p-3 hover:bg-white/10 rounded-lg transition-all">
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <button onclick="startRecording()" id="recordBtn" class="p-3 hover:bg-white/10 rounded-lg transition-all">
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <input type="text" id="messageText" placeholder="Digite sua mensagem..." 
                           class="flex-1 p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-primary"
                           onkeypress="handleEnter(event)"
                           oninput="handleTyping()">
                    <button onclick="toggleEmojiPicker()" class="p-3 hover:bg-white/10 rounded-lg transition-all">
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <button onclick="sendMessage()" class="p-3 bg-primary hover:bg-primary/80 rounded-lg transition-all">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                        </svg>
                    </button>
                </div>
                <div id="filePreview" class="mt-3 hidden"></div>
            </div>
        </div>
    </div>

    <!-- Video Call Overlay -->
    <div id="videoCallOverlay" class="fixed inset-0 video-call-overlay z-50 hidden">
        <div class="h-full flex flex-col">
            <!-- Call Header -->
            <div class="p-6 text-center">
                <h3 id="callUserName" class="text-white text-2xl font-bold mb-2">Chamando...</h3>
                <p id="callStatus" class="text-gray-300">Conectando...</p>
                <p id="callTimer" class="text-gray-400 text-sm hidden">00:00</p>
            </div>

            <!-- Video Area -->
            <div class="flex-1 relative">
                <video id="remoteVideo" class="w-full h-full object-cover" autoplay playsinline></video>
                <video id="localVideo" class="absolute bottom-4 right-4 w-48 h-36 object-cover rounded-lg border-2 border-white" autoplay playsinline muted></video>
                
                <!-- Screen Share Video -->
                <video id="screenShareVideo" class="w-full h-full object-contain hidden" autoplay playsinline></video>
                
                <!-- Call Controls -->
                <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex space-x-4">
                    <button id="muteBtn" onclick="toggleMute()" class="p-4 bg-gray-600 hover:bg-gray-700 rounded-full transition-all">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM15.657 6.343a1 1 0 011.414 0A9.972 9.972 0 0119 12a9.972 9.972 0 01-1.929 5.657 1 1 0 11-1.414-1.414A7.971 7.971 0 0017 12c0-1.594-.471-3.078-1.343-4.243a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <button id="videoBtn" onclick="toggleVideo()" class="p-4 bg-gray-600 hover:bg-gray-700 rounded-full transition-all">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                        </svg>
                    </button>
                    <button id="screenShareBtn" onclick="toggleScreenShare()" class="p-4 bg-gray-600 hover:bg-gray-700 rounded-full transition-all">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z"/>
                        </svg>
                    </button>
                    <button onclick="endCall()" class="p-4 bg-red-500 hover:bg-red-600 rounded-full transition-all">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Call Overlay -->
    <div id="audioCallOverlay" class="fixed inset-0 video-call-overlay z-50 hidden">
        <div class="h-full flex flex-col items-center justify-center">
            <div class="text-center mb-12">
                <div class="w-32 h-32 mx-auto mb-6">
                    <img id="audioCallAvatar" src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/673b1583-a94b-4401-9505-3229c2cf89b7.png" alt="Avatar do usuário em chamada de áudio" class="w-full h-full rounded-full"/>
                </div>
                <h3 id="audioCallUserName" class="text-white text-3xl font-bold mb-2">Chamando...</h3>
                <p id="audioCallStatus" class="text-gray-300 text-lg">Conectando...</p>
                <p id="audioCallTimer" class="text-gray-400 text-sm mt-2 hidden">00:00</p>
            </div>

            <!-- Audio Controls -->
            <div class="flex space-x-6">
                <button id="audioMuteBtn" onclick="toggleMute()" class="p-6 bg-gray-600 hover:bg-gray-700 rounded-full transition-all">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM15.657 6.343a1 1 0 011.414 0A9.972 9.972 0 0119 12a9.972 9.972 0 01-1.929 5.657 1 1 0 11-1.414-1.414A7.971 7.971 0 0017 12c0-1.594-.471-3.078-1.343-4.243a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <button onclick="endCall()" class="p-6 bg-red-500 hover:bg-red-600 rounded-full transition-all">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Add Contact/Group Modal -->
    <div id="addModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="glass-effect p-6 rounded-2xl w-full max-w-md">
            <h3 class="text-xl font-bold text-white mb-4">Adicionar Contato</h3>
            <div class="space-y-4">
                <input type="text" id="addContactName" placeholder="Nome do usuário" 
                       class="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-primary">
                <input type="email" id="addContactEmail" placeholder="E-mail do usuário" 
                       class="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-primary">
                <div class="flex space-x-3">
                    <button onclick="addContact()" class="flex-1 p-3 bg-primary hover:bg-primary/80 rounded-xl text-white font-medium transition-all">
                        Adicionar
                    </button>
                    <button onclick="closeAddModal()" class="flex-1 p-3 border border-white/30 rounded-xl text-gray-300 hover:bg-white/10 transition-all">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="glass-effect p-6 rounded-2xl w-full max-w-md">
            <h3 class="text-xl font-bold text-white mb-4">Configurações</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label class="text-white">Notificações</label>
                    <input type="checkbox" id="notificationsEnabled" class="toggle">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-white">Som de Notificação</label>
                    <input type="checkbox" id="soundEnabled" class="toggle">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-white">Modo Escuro</label>
                    <input type="checkbox" id="darkModeEnabled" class="toggle" checked>
                </div>
                <div>
                    <label class="text-white block mb-2">Status</label>
                    <select id="statusSelect" class="w-full p-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:border-primary">
                        <option value="online">Online</option>
                        <option value="away">Ausente</option>
                        <option value="busy">Ocupado</option>
                        <option value="invisible">Invisível</option>
                    </select>
                </div>
                <button onclick="closeSettingsModal()" class="w-full p-3 bg-primary hover:bg-primary/80 rounded-xl text-white font-medium transition-all">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incomingCallModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-60 hidden">
        <div class="glass-effect p-8 rounded-2xl text-center">
            <div class="w-24 h-24 mx-auto mb-4">
                <img id="incomingCallAvatar" src="" alt="Avatar do usuário chamando" class="w-full h-full rounded-full"/ src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/0c97368b-b7c7-49c0-8fcf-c304f2430fdf.png">
            </div>
            <h3 id="incomingCallName" class="text-2xl font-bold text-white mb-2">Chamada recebida</h3>
            <p id="incomingCallType" class="text-gray-300 mb-6">Chamada de vídeo</p>
            <div class="flex space-x-4">
                <button onclick="acceptCall()" class="p-4 bg-green-500 hover:bg-green-600 rounded-full transition-all">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                    </svg>
                </button>
                <button onclick="rejectCall()" class="p-4 bg-red-500 hover:bg-red-600 rounded-full transition-all">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 z-50 notification hidden">
        <div class="glass-effect p-4 rounded-lg max-w-sm cursor-pointer" onclick="hideNotification()">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2L3 9h4v9h6v-9h4l-7-7z"/>
                    </svg>
                </div>
                <div>
                    <p id="notificationTitle" class="text-white font-medium">Nova mensagem</p>
                    <p id="notificationBody" class="text-gray-300 text-sm">Você tem uma nova mensagem</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button onclick="showQuickActions()" class="floating-btn fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center z-40">
        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
        </svg>
    </button>

    <script>
        // Global Variables
        let currentChat = null;
        let currentUser = null;
        let currentUserEmail = null;
        let socket = null;
        let isCallActive = false;
        let isMuted = false;
        let isVideoOn = true;
        let isScreenSharing = false;
        let localStream = null;
        let screenStream = null;
        let peerConnection = null;
        let callTimer = null;
        let callStartTime = null;
        let typingTimeout = null;
        let isTyping = false;
        let recordingState = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let notificationsEnabled = true;
        let soundEnabled = true;

        // WebRTC Configuration
        const rtcConfiguration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Data Storage
        const userData = {
            chats: JSON.parse(localStorage.getItem('talkhub_chats') || '{}'),
            contacts: JSON.parse(localStorage.getItem('talkhub_contacts') || '{}'),
            groups: JSON.parse(localStorage.getItem('talkhub_groups') || '{}'),
            settings: JSON.parse(localStorage.getItem('talkhub_settings') || '{}')
        };

        // Initialize App
        function initializeApp() {
            // Check for stored user session
            const storedUser = localStorage.getItem('talkhub_user');
            if (storedUser) {
                const user = JSON.parse(storedUser);
                currentUser = user.name;
                currentUserEmail = user.email;
                showMainApp();
            }

            // Initialize WebSocket connection (simulated)
            initializeWebSocket();

            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            // Load user settings
            loadUserSettings();
        }

        // Initialize WebSocket Connection (Simulated)
        function initializeWebSocket() {
            // Since we can't use real WebSocket server, we'll simulate it
            socket = {
                emit: function(event, data) {
                    console.log('Emitting:', event, data);
                },
                on: function(event, callback) {
                    this[event] = callback;
                },
                connected: true
            };

            // Simulate connection status
            updateConnectionStatus('connected');
            
            // Simulate periodic connection check
            setInterval(() => {
                if (Math.random() < 0.1) { // 10% chance of temporary disconnect
                    updateConnectionStatus('reconnecting');
                    setTimeout(() => {
                        updateConnectionStatus('connected');
                    }, 2000);
                }
            }, 30000);

            // Simulate online users
            updateOnlineCount(Math.floor(Math.random() * 100) + 20);
        }

        // Update Connection Status
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    statusEl.textContent = 'Conectado';
                    statusEl.classList.remove('hidden');
                    setTimeout(() => statusEl.classList.add('hidden'), 3000);
                    break;
                case 'disconnected':
                    statusEl.textContent = 'Desconectado';
                    statusEl.classList.remove('hidden');
                    break;
                case 'reconnecting':
                    statusEl.textContent = 'Reconectando...';
                    statusEl.classList.remove('hidden');
                    break;
            }
        }

        // Login System
        let isRegisterMode = false;

        function toggleRegisterMode() {
            isRegisterMode = !isRegisterMode;
            const emailInput = document.getElementById('emailInput');
            const toggleBtn = document.getElementById('registerToggle');
            
            if (isRegisterMode) {
                emailInput.style.display = 'block';
                emailInput.required = true;
                toggleBtn.textContent = 'Já tenho conta';
            } else {
                emailInput.style.display = 'none';
                emailInput.required = false;
                toggleBtn.textContent = 'Criar Conta';
            }
        }

        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            
            if (!username || (isRegisterMode && !email)) {
                showNotification('Erro', 'Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            // Store user session
            const userData = { 
                name: username, 
                email: email || `${username}@talkhub.com`,
                avatar: generateAvatar(username),
                status: 'online',
                lastSeen: new Date().toISOString()
            };
            
            localStorage.setItem('talkhub_user', JSON.stringify(userData));
            
            currentUser = username;
            currentUserEmail = userData.email;
            
            showMainApp();
            showNotification('Login realizado', `Bem-vindo${isRegisterMode ? '' : ' de volta'}, ${username}!`);
        }

        function logout() {
            localStorage.removeItem('talkhub_user');
            currentUser = null;
            currentUserEmail = null;
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            if (socket && socket.connected) {
                socket.emit('disconnect');
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user interface
            document.getElementById('currentUserName').textContent = currentUser;
            document.getElementById('userInitials').textContent = currentUser.charAt(0).toUpperCase();
            
            // Load user data
            loadChats();
            loadContacts();
            loadGroups();
            
            // Join socket room
            if (socket) {
                socket.emit('join', { username: currentUser, email: currentUserEmail });
            }
        }

        // Avatar Generation
        function generateAvatar(name) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            const color = colors[name.length % colors.length];
            return `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><rect width="40" height="40" fill="${color}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18" fill="white">${name.charAt(0).toUpperCase()}</text></svg>`;
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('chatsList').classList.add('hidden');
            document.getElementById('groupsList').classList.add('hidden');
            document.getElementById('contactsList').classList.add('hidden');
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary/20', 'border-b-2', 'border-primary', 'text-white');
                btn.classList.add('text-gray-400');
            });
            
            // Show selected tab and activate button
            document.getElementById(tabName + 'List').classList.remove('hidden');
            event.target.classList.add('bg-primary/20', 'border-b-2', 'border-primary', 'text-white');
            event.target.classList.remove('text-gray-400');
            
            // Load appropriate data
            switch(tabName) {
                case 'chats':
                    loadChats();
                    break;
                case 'groups':
                    loadGroups();
                    break;
                case 'contacts':
                    loadContacts();
                    break;
            }
        }

        // Data Loading Functions
        function loadChats() {
            const chatsList = document.getElementById('chatsList');
            chatsList.innerHTML = '';
            
            // Load from localStorage
            const chats = userData.chats;
            
            if (Object.keys(chats).length === 0) {
                // Show empty state
                chatsList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-500/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <p class="text-gray-400 text-sm">Nenhuma conversa ainda</p>
                        <p class="text-gray-500 text-xs mt-1">Adicione contatos para começar a conversar</p>
                    </div>
                `;
                return;
            }
            
            Object.values(chats).forEach(chat => {
                const chatItem = createChatItem(chat);
                chatsList.appendChild(chatItem);
            });
        }

        function loadContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            
            const contacts = userData.contacts;
            
            if (Object.keys(contacts).length === 0) {
                // Show empty state
                contactsList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-500/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                        </div>
                        <p class="text-gray-400 text-sm">Nenhum contato adicionado</p>
                        <p class="text-gray-500 text-xs mt-1">Clique em "Novo Chat" para adicionar contatos</p>
                    </div>
                `;
                return;
            }
            
            Object.values(contacts).forEach(contact => {
                const contactItem = createContactItem(contact);
                contactsList.appendChild(contactItem);
            });
        }

        function loadGroups() {
            const groupsList = document.getElementById('groupsList');
            groupsList.innerHTML = '';
            
            const groups = userData.groups;
            
            if (Object.keys(groups).length === 0) {
                // Show empty state
                groupsList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-500/20 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                        </div>
                        <p class="text-gray-400 text-sm">Nenhum grupo criado</p>
                        <p class="text-gray-500 text-xs mt-1">Crie ou participe de grupos</p>
                    </div>
                `;
                return;
            }
            
            Object.values(groups).forEach(group => {
                const groupItem = createGroupItem(group);
                groupsList.appendChild(groupItem);
            });
        }

        // Item Creation Functions
        function createChatItem(chat) {
            const div = document.createElement('div');
            div.className = 'chat-item p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-all';
            div.onclick = () => selectChat(chat.name);
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <img src="${chat.avatar}" alt="Avatar de ${chat.name}" class="w-10 h-10 rounded-full"/>
                        ${chat.online ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full border border-white"></span>' : '<span class="absolute -top-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border border-white"></span>'}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <h4 class="text-white font-medium">${chat.name}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-400">${chat.time || 'Agora'}</span>
                                ${chat.unread > 0 ? `<span class="bg-primary text-white text-xs px-2 py-1 rounded-full">${chat.unread}</span>` : ''}
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 truncate">${chat.lastMessage || 'Nenhuma mensagem'}</p>
                    </div>
                </div>
            `;
            
            return div;
        }

        function createContactItem(contact) {
            const div = document.createElement('div');
            div.className = 'contact-item p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-all';
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${contact.avatar}" alt="Avatar de ${contact.name}" class="w-10 h-10 rounded-full"/>
                    <div class="flex-1">
                        <h4 class="text-white font-medium">${contact.name}</h4>
                        <p class="text-sm text-gray-400">${contact.username}</p>
                        <p class="text-xs ${contact.online ? 'text-green-400' : 'text-gray-500'}">${contact.online ? 'Online' : 'Offline'}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="startCall('${contact.name}', 'video')" class="p-2 bg-green-500 hover:bg-green-600 rounded-lg transition-all">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                            </svg>
                        </button>
                        <button onclick="startCall('${contact.name}', 'audio')" class="p-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-all">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                            </svg>
                        </button>
                        <button onclick="startChat('${contact.name}')" class="p-2 bg-primary hover:bg-primary/80 rounded-lg transition-all">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }

        function createGroupItem(group) {
            const div = document.createElement('div');
            div.className = 'group-item p-3 hover:bg-white/10 rounded-xl cursor-pointer transition-all';
            div.onclick = () => selectGroup(group.name);
            
            div.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-r ${group.color} rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <h4 class="text-white font-medium">${group.name}</h4>
                            <span class="text-xs text-gray-400">${group.time || 'Agora'}</span>
                        </div>
                        <p class="text-sm text-gray-400 truncate">${group.lastMessage || 'Nenhuma mensagem'}</p>
                        <p class="text-xs text-gray-500">${group.members} membros</p>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Chat Functions
        function selectChat(userName) {
            currentChat = userName;
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
            document.getElementById('messageInput').classList.remove('hidden');
            
            document.getElementById('chatUserName').textContent = userName;
            document.getElementById('chatUserStatus').textContent = 'Online';
            document.getElementById('chatUserAvatar').src = generateAvatar(userName);
            
            loadMessages(userName);
            
            // Mark messages as read
            markMessagesAsRead(userName);
        }

        function selectGroup(groupName) {
            currentChat = groupName;
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
            document.getElementById('messageInput').classList.remove('hidden');
            
            document.getElementById('chatUserName').textContent = groupName;
            document.getElementById('chatUserStatus').textContent = 'Grupo ativo';
            
            loadGroupMessages(groupName);
        }

        function loadMessages(userName) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Get messages from storage
            const chatKey = `${currentUser}-${userName}`;
            const messages = JSON.parse(localStorage.getItem(`talkhub_messages_${chatKey}`) || '[]');
            
            if (messages.length === 0) {
                // Show empty state
                messagesContainer.innerHTML = `
                    <div class="flex-1 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gray-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <p class="text-gray-400 text-lg">Nenhuma mensagem ainda</p>
                            <p class="text-gray-500 text-sm mt-1">Envie a primeira mensagem para ${userName}</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                const messageDiv = createMessageElement(message);
                messagesContainer.appendChild(messageDiv);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function loadGroupMessages(groupName) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            // Get group messages from storage
            const messages = JSON.parse(localStorage.getItem(`talkhub_group_messages_${groupName}`) || '[]');
            
            if (messages.length === 0) {
                // Show empty state
                messagesContainer.innerHTML = `
                    <div class="flex-1 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gray-500/20 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                </svg>
                            </div>
                            <p class="text-gray-400 text-lg">Nenhuma mensagem ainda</p>
                            <p class="text-gray-500 text-sm mt-1">Seja o primeiro a enviar uma mensagem no grupo ${groupName}</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                const messageDiv = createGroupMessageElement(message);
                messagesContainer.appendChild(messageDiv);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${message.isOwn ? 'justify-end' : 'justify-start'}`;
            messageDiv.setAttribute('data-message-id', message.id);
            
            const timeStr = message.time || new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${message.isOwn ? 'bg-primary' : 'bg-white/10'} p-3 rounded-2xl max-w-xs sm:max-w-md">
                    ${message.file ? createFilePreview(message.file) : ''}
                    ${message.message ? `<p class="text-white">${message.message}</p>` : ''}
                    <div class="flex items-center justify-between mt-2">
                        <p class="text-xs ${message.isOwn ? 'text-primary-200' : 'text-gray-400'}">${timeStr}</p>
                        ${message.isOwn ? `<span class="text-xs ${message.read ? 'text-blue-400' : 'text-gray-400'}">${message.read ? '✓✓' : '✓'}</span>` : ''}
                    </div>
                </div>
            `;
            
            return messageDiv;
        }

        function createGroupMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${message.isOwn ? 'justify-end' : 'justify-start'}`;
            
            const timeStr = message.time || new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${message.isOwn ? 'bg-primary' : 'bg-white/10'} p-3 rounded-2xl max-w-xs sm:max-w-md">
                    ${!message.isOwn ? `<p class="text-xs text-gray-300 mb-1 font-medium">${message.sender}</p>` : ''}
                    ${message.file ? createFilePreview(message.file) : ''}
                    ${message.message ? `<p class="text-white">${message.message}</p>` : ''}
                    <p class="text-xs ${message.isOwn ? 'text-primary-200' : 'text-gray-400'} mt-1">${timeStr}</p>
                </div>
            `;
            
            return messageDiv;
        }

        function createFilePreview(file) {
            const fileType = file.type || '';
            
            if (fileType.startsWith('image/')) {
                return `<img src="${file.url}" alt="${file.name}" class="file-preview rounded-lg mb-2 max-w-full"/>`;
            } else if (fileType.startsWith('audio/')) {
                return `<audio controls class="mb-2"><source src="${file.url}" type="${fileType}">Seu navegador não suporta áudio.</audio>`;
            } else if (fileType.startsWith('video/')) {
                return `<video controls class="file-preview rounded-lg mb-2"><source src="${file.url}" type="${fileType}">Seu navegador não suporta vídeo.</video>`;
            } else {
                return `
                    <div class="flex items-center space-x-2 p-2 bg-white/10 rounded-lg mb-2">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <p class="text-white text-sm">${file.name}</p>
                            <p class="text-gray-400 text-xs">${formatFileSize(file.size)}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Messaging Functions
        function sendMessage() {
            const messageText = document.getElementById('messageText').value.trim();
            const filePreview = document.getElementById('filePreview');
            const hasFiles = filePreview.children.length > 0;
            
            if (!messageText && !hasFiles) return;
            if (!currentChat) return;
            
            const messageData = {
                id: Date.now(),
                sender: currentUser,
                message: messageText,
                time: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                isOwn: true,
                read: false,
                timestamp: new Date().toISOString()
            };

            // Handle file attachments
            if (hasFiles) {
                const files = [];
                Array.from(filePreview.children).forEach(preview => {
                    const fileData = preview.dataset.file ? JSON.parse(preview.dataset.file) : null;
                    if (fileData) {
                        files.push(fileData);
                    }
                });
                if (files.length > 0) {
                    messageData.file = files[0]; // For simplicity, just use the first file
                }
            }
            
            // Add message to UI
            const messagesContainer = document.getElementById('chatMessages');
            
            // If messages container shows empty state, clear it first
            if (messagesContainer.innerHTML.includes('Nenhuma mensagem ainda')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = createMessageElement(messageData);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Save message to storage
            saveMessage(currentChat, messageData);
            
            // Clear input and file preview
            document.getElementById('messageText').value = '';
            filePreview.innerHTML = '';
            filePreview.classList.add('hidden');
            
            // Send via socket
            if (socket) {
                socket.emit('message', {
                    to: currentChat,
                    from: currentUser,
                    message: messageText,
                    file: messageData.file,
                    timestamp: messageData.timestamp
                });
            }
            
            // Update last message in chat list
            updateChatLastMessage(currentChat, messageText || 'Arquivo enviado');
        }

        function saveMessage(chatPartner, messageData) {
            const chatKey = `${currentUser}-${chatPartner}`;
            const messages = JSON.parse(localStorage.getItem(`talkhub_messages_${chatKey}`) || '[]');
            messages.push(messageData);
            localStorage.setItem(`talkhub_messages_${chatKey}`, JSON.stringify(messages));
        }

        // File Handling
        function handleFileSelect(event) {
            const files = event.target.files;
            const filePreview = document.getElementById('filePreview');
            
            filePreview.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        url: e.target.result
                    };
                    
                    const preview = document.createElement('div');
                    preview.className = 'flex items-center space-x-3 p-3 bg-white/10 rounded-lg mb-2';
                    preview.dataset.file = JSON.stringify(fileData);
                    
                    if (file.type.startsWith('image/')) {
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}" class="w-12 h-12 object-cover rounded"/>
                            <div class="flex-1">
                                <p class="text-white text-sm">${file.name}</p>
                                <p class="text-gray-400 text-xs">${formatFileSize(file.size)}</p>
                            </div>
                            <button onclick="removeFilePreview(this)" class="p-1 hover:bg-white/10 rounded">
                                <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        `;
                    } else {
                        preview.innerHTML = `
                            <div class="w-12 h-12 bg-primary/20 rounded flex items-center justify-center">
                                <svg class="w-6 h-6 text-primary" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-white text-sm">${file.name}</p>
                                <p class="text-gray-400 text-xs">${formatFileSize(file.size)}</p>
                            </div>
                            <button onclick="removeFilePreview(this)" class="p-1 hover:bg-white/10 rounded">
                                <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        `;
                    }
                    
                    filePreview.appendChild(preview);
                    filePreview.classList.remove('hidden');
                };
                
                reader.readAsDataURL(file);
            });
            
            // Clear the input
            event.target.value = '';
        }

        function removeFilePreview(button) {
            const preview = button.parentElement;
            preview.remove();
            
            const filePreview = document.getElementById('filePreview');
            if (filePreview.children.length === 0) {
                filePreview.classList.add('hidden');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Voice Recording
        function startRecording() {
            if (recordingState) {
                stopRecording();
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];
                    
                    mediaRecorder.addEventListener('dataavailable', event => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    });
                    
                    mediaRecorder.addEventListener('stop', () => {
                        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                        const url = URL.createObjectURL(blob);
                        
                        // Create audio message
                        const audioFile = {
                            name: `audio_${Date.now()}.webm`,
                            type: 'audio/webm',
                            size: blob.size,
                            url: url
                        };
                        
                        // Add to file preview
                        const filePreview = document.getElementById('filePreview');
                        const preview = document.createElement('div');
                        preview.className = 'flex items-center space-x-3 p-3 bg-white/10 rounded-lg mb-2';
                        preview.dataset.file = JSON.stringify(audioFile);
                        
                        preview.innerHTML = `
                            <div class="w-12 h-12 bg-green-500/20 rounded flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-white text-sm">Gravação de áudio</p>
                                <audio controls class="mt-1">
                                    <source src="${url}" type="audio/webm">
                                </audio>
                            </div>
                            <button onclick="removeFilePreview(this)" class="p-1 hover:bg-white/10 rounded">
                                <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        `;
                        
                        filePreview.appendChild(preview);
                        filePreview.classList.remove('hidden');
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    });
                    
                    mediaRecorder.start();
                    recordingState = true;
                    
                    // Update UI
                    const recordBtn = document.getElementById('recordBtn');
                    recordBtn.innerHTML = `
                        <svg class="w-5 h-5 text-red-400 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 012 0v4a1 1 0 11-2 0V7z" clip-rule="evenodd"/>
                        </svg>
                    `;
                    recordBtn.title = 'Parar gravação';
                    
                    showNotification('Gravação iniciada', 'Clique novamente para parar');
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    showNotification('Erro', 'Não foi possível acessar o microfone');
                });
        }

        function stopRecording() {
            if (mediaRecorder && recordingState) {
                mediaRecorder.stop();
                recordingState = false;
                
                // Reset UI
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.innerHTML = `
                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                    </svg>
                `;
                recordBtn.title = 'Gravar áudio';
            }
        }

        // Typing Indicators
        function handleTyping() {
            if (!isTyping && currentChat) {
                isTyping = true;
                // Send typing indicator via socket
                if (socket) {
                    socket.emit('typing', { to: currentChat, from: currentUser });
                }
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                if (socket) {
                    socket.emit('stopTyping', { to: currentChat, from: currentUser });
                }
            }, 1000);
        }

        function showTypingIndicator(userName) {
            if (currentChat === userName) {
                const indicator = document.getElementById('typingIndicator');
                indicator.classList.remove('hidden');
                
                setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 3000);
            }
        }

        // WebRTC Call Functions
        async function startCall(userName, type) {
            if (isCallActive) return;
            
            try {
                isCallActive = true;
                currentCall = { user: userName, type: type };
                
                // Get user media
                const constraints = {
                    audio: true,
                    video: type === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                if (type === 'video') {
                    document.getElementById('videoCallOverlay').classList.remove('hidden');
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('callUserName').textContent = userName;
                    document.getElementById('callStatus').textContent = 'Chamando...';
                } else {
                    document.getElementById('audioCallOverlay').classList.remove('hidden');
                    document.getElementById('audioCallUserName').textContent = userName;
                    document.getElementById('audioCallStatus').textContent = 'Chamando...';
                    document.getElementById('audioCallAvatar').src = generateAvatar(userName);
                }
                
                // Create peer connection
                peerConnection = new RTCPeerConnection(rtcConfiguration);
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    if (type === 'video') {
                        document.getElementById('remoteVideo').srcObject = event.streams[0];
                    }
                };
                
                // Simulate call connection after 3 seconds
                setTimeout(() => {
                    if (type === 'video') {
                        document.getElementById('callStatus').textContent = 'Conectado';
                        document.getElementById('callTimer').classList.remove('hidden');
                    } else {
                        document.getElementById('audioCallStatus').textContent = 'Conectado';
                        document.getElementById('audioCallTimer').classList.remove('hidden');
                    }
                    
                    startCallTimer();
                }, 3000);
                
                showNotification('Chamada iniciada', `Chamando ${userName}...`);
                
            } catch (error) {
                console.error('Error starting call:', error);
                showNotification('Erro', 'Não foi possível iniciar a chamada');
                endCall();
            }
        }

        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Date.now() - callStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const videoTimer = document.getElementById('callTimer');
                const audioTimer = document.getElementById('audioCallTimer');
                
                if (videoTimer && !videoTimer.classList.contains('hidden')) {
                    videoTimer.textContent = timeString;
                }
                if (audioTimer && !audioTimer.classList.contains('hidden')) {
                    audioTimer.textContent = timeString;
                }
            }, 1000);
        }

        function toggleMute() {
            if (!localStream) return;
            
            isMuted = !isMuted;
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !isMuted;
            }
            
            // Update button appearance
            const muteBtns = [document.getElementById('muteBtn'), document.getElementById('audioMuteBtn')];
            muteBtns.forEach(btn => {
                if (btn) {
                    btn.classList.toggle('bg-red-500', isMuted);
                    btn.classList.toggle('bg-gray-600', !isMuted);
                }
            });
            
            showNotification('Microfone', isMuted ? 'Desativado' : 'Ativado');
        }

        function toggleVideo() {
            if (!localStream) return;
            
            isVideoOn = !isVideoOn;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = isVideoOn;
            }
            
            // Update button appearance
            const videoBtn = document.getElementById('videoBtn');
            if (videoBtn) {
                videoBtn.classList.toggle('bg-red-500', !isVideoOn);
                videoBtn.classList.toggle('bg-gray-600', isVideoOn);
            }
            
            showNotification('Câmera', isVideoOn ? 'Ativada' : 'Desativada');
        }

        async function toggleScreenShare() {
            try {
                if (!isScreenSharing) {
                    // Start screen sharing
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });
                    
                    // Replace video track in peer connection
                    const videoTrack = screenStream.getVideoTracks()[0];
                    const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) {
                        await sender.replaceTrack(videoTrack);
                    }
                    
                    // Update local video
                    document.getElementById('localVideo').srcObject = screenStream;
                    document.getElementById('screenShareVideo').srcObject = screenStream;
                    document.getElementById('screenShareVideo').classList.remove('hidden');
                    
                    // Handle screen share end
                    videoTrack.onended = () => {
                        stopScreenShare();
                    };
                    
                    isScreenSharing = true;
                    document.getElementById('screenShareBtn').classList.add('bg-primary');
                    
                    showNotification('Compartilhamento de tela', 'Iniciado');
                    
                } else {
                    stopScreenShare();
                }
            } catch (error) {
                console.error('Error sharing screen:', error);
                showNotification('Erro', 'Não foi possível compartilhar a tela');
            }
        }

        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                
                // Replace with camera track
                const videoTrack = localStream.getVideoTracks()[0];
                const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                if (sender && videoTrack) {
                    sender.replaceTrack(videoTrack);
                }
                
                // Update UI
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('screenShareVideo').classList.add('hidden');
                
                isScreenSharing = false;
                document.getElementById('screenShareBtn').classList.remove('bg-primary');
                
                showNotification('Compartilhamento de tela', 'Finalizado');
            }
        }

        function endCall() {
            isCallActive = false;
            
            // Stop all media tracks
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Stop call timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Hide call overlays
            document.getElementById('videoCallOverlay').classList.add('hidden');
            document.getElementById('audioCallOverlay').classList.add('hidden');
            document.getElementById('incomingCallModal').classList.add('hidden');
            
            // Reset call state
            isMuted = false;
            isVideoOn = true;
            isScreenSharing = false;
            
            // Reset UI
            document.getElementById('callTimer').classList.add('hidden');
            document.getElementById('audioCallTimer').classList.add('hidden');
            
            showNotification('Chamada encerrada', 'A chamada foi finalizada');
        }

        // Call handling functions for incoming calls
        function acceptCall() {
            // In a real implementation, this would accept the WebRTC call
            document.getElementById('incomingCallModal').classList.add('hidden');
            
            // For demo purposes, just start a regular call
            const callData = currentIncomingCall;
            if (callData) {
                startCall(callData.from, callData.type);
            }
        }

        function rejectCall() {
            document.getElementById('incomingCallModal').classList.add('hidden');
            currentIncomingCall = null;
        }

        // Utility Functions
        function handleEnter(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function searchConversations() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeTab = document.querySelector('.tab-btn.text-white').textContent.toLowerCase().trim();
            
            let items;
            if (activeTab === 'chats') {
                items = document.querySelectorAll('#chatsList .chat-item');
            } else if (activeTab === 'grupos') {
                items = document.querySelectorAll('#groupsList .group-item');
            } else if (activeTab === 'contatos') {
                items = document.querySelectorAll('#contactsList .contact-item');
            }
            
            if (items) {
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            }
        }

        function updateChatLastMessage(userName, message) {
            // Update the chat item in the list with the new last message
            const chatItems = document.querySelectorAll('.chat-item');
            chatItems.forEach(item => {
                const nameElement = item.querySelector('h4');
                if (nameElement && nameElement.textContent === userName) {
                    const messageElement = item.querySelector('.text-gray-400');
                    if (messageElement) {
                        messageElement.textContent = message.length > 50 ? message.substring(0, 50) + '...' : message;
                    }
                    
                    // Update time
                    const timeElement = item.querySelector('.text-xs');
                    if (timeElement) {
                        timeElement.textContent = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                    }
                }
            });
            
            // Update or create chat in userData
            const currentTime = new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            userData.chats[userName] = {
                name: userName,
                lastMessage: message,
                time: currentTime,
                online: true,
                unread: 0,
                avatar: generateAvatar(userName)
            };
            localStorage.setItem('talkhub_chats', JSON.stringify(userData.chats));
        }

        function markMessagesAsRead(userName) {
            const chatKey = `${currentUser}-${userName}`;
            const messages = JSON.parse(localStorage.getItem(`talkhub_messages_${chatKey}`) || '[]');
            
            messages.forEach(message => {
                if (!message.isOwn) {
                    message.read = true;
                }
            });
            
            localStorage.setItem(`talkhub_messages_${chatKey}`, JSON.stringify(messages));
        }

        function updateOnlineCount(count) {
            const onlineCountElement = document.getElementById('onlineCount');
            if (onlineCountElement) {
                onlineCountElement.textContent = count;
            }
        }

        function startChat(userName) {
            // Create or update chat in userData
            userData.chats[userName] = {
                name: userName,
                lastMessage: '',
                time: new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}),
                online: true,
                unread: 0,
                avatar: generateAvatar(userName)
            };
            localStorage.setItem('talkhub_chats', JSON.stringify(userData.chats));
            
            selectChat(userName);
            
            // Switch to chats tab
            showTab('chats');
            
            // Update tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary/20', 'border-b-2', 'border-primary', 'text-white');
                btn.classList.add('text-gray-400');
            });
            
            const chatsTab = document.querySelector('.tab-btn:first-child');
            chatsTab.classList.add('bg-primary/20', 'border-b-2', 'border-primary', 'text-white');
            chatsTab.classList.remove('text-gray-400');
        }

        // Notification Functions
        function showNotification(title, body, onClick = null) {
            // Browser notification
            if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: '/favicon.ico',
                    tag: 'talkhub-notification'
                });
                
                if (onClick) {
                    notification.onclick = onClick;
                }
                
                setTimeout(() => notification.close(), 5000);
            }
            
            // In-app notification
            const notification = document.getElementById('notification');
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationBody').textContent = body;
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 4000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.add('hidden');
        }

        function playNotificationSound() {
            if (soundEnabled) {
                // Create a simple notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }

        function toggleNotifications() {
            notificationsEnabled = !notificationsEnabled;
            const btn = document.getElementById('notificationToggle');
            
            if (notificationsEnabled) {
                btn.classList.remove('text-gray-400');
                btn.classList.add('text-primary');
                
                // Request permission if needed
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
                
                showNotification('Notificações', 'Ativadas');
            } else {
                btn.classList.remove('text-primary');
                btn.classList.add('text-gray-400');
                showNotification('Notificações', 'Desativadas');
            }
            
            // Save setting
            userData.settings.notificationsEnabled = notificationsEnabled;
            localStorage.setItem('talkhub_settings', JSON.stringify(userData.settings));
        }

        // Modal Functions
        function showAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('addContactName').value = '';
            document.getElementById('addContactEmail').value = '';
        }

        function addContact() {
            const name = document.getElementById('addContactName').value.trim();
            const email = document.getElementById('addContactEmail').value.trim();
            
            if (!name || !email) {
                showNotification('Erro', 'Por favor, preencha todos os campos.');
                return;
            }
            
            // Add to contacts
            userData.contacts[email] = {
                name: name,
                email: email,
                username: `@${name.toLowerCase().replace(' ', '_')}`,
                online: Math.random() > 0.5,
                avatar: generateAvatar(name),
                addedAt: new Date().toISOString()
            };
            
            localStorage.setItem('talkhub_contacts', JSON.stringify(userData.contacts));
            
            closeAddModal();
            showNotification('Contato adicionado', `${name} foi adicionado aos seus contatos.`);
            
            // Refresh contacts list if visible
            if (!document.getElementById('contactsList').classList.contains('hidden')) {
                loadContacts();
            }
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            
            // Load current settings
            document.getElementById('notificationsEnabled').checked = notificationsEnabled;
            document.getElementById('soundEnabled').checked = soundEnabled;
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
            
            // Save settings
            notificationsEnabled = document.getElementById('notificationsEnabled').checked;
            soundEnabled = document.getElementById('soundEnabled').checked;
            
            userData.settings.notificationsEnabled = notificationsEnabled;
            userData.settings.soundEnabled = soundEnabled;
            localStorage.setItem('talkhub_settings', JSON.stringify(userData.settings));
            
            showNotification('Configurações', 'Salvas com sucesso');
        }

        function loadUserSettings() {
            const settings = userData.settings;
            notificationsEnabled = settings.notificationsEnabled !== false;
            soundEnabled = settings.soundEnabled !== false;
        }

        function showChatInfo() {
            if (!currentChat) return;
            
            showNotification('Informações do Chat', `Conversando com: ${currentChat}`);
        }

        function showProfileModal() {
            showNotification('Perfil', 'Funcionalidade de perfil em desenvolvimento');
        }

        function showQuickActions() {
            showNotification('Ações Rápidas', 'Menu de ações rápidas em desenvolvimento');
        }

        function shareScreen() {
            if (isCallActive) {
                toggleScreenShare();
            } else {
                showNotification('Compartilhar Tela', 'Disponível apenas durante chamadas');
            }
        }

        function toggleEmojiPicker() {
            showNotification('Emojis', 'Seletor de emojis em desenvolvimento');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Escape key to close modals or calls
                if (e.key === 'Escape') {
                    if (isCallActive) {
                        endCall();
                    } else {
                        // Close any open modals
                        document.getElementById('addModal').classList.add('hidden');
                        document.getElementById('settingsModal').classList.add('hidden');
                        document.getElementById('incomingCallModal').classList.add('hidden');
                    }
                }
                
                // Ctrl+M to toggle mute during call
                if (e.ctrlKey && e.key === 'm' && isCallActive) {
                    e.preventDefault();
                    toggleMute();
                }
                
                // Ctrl+Shift+V to toggle video during call
                if (e.ctrlKey && e.shiftKey && e.key === 'V' && isCallActive) {
                    e.preventDefault();
                    toggleVideo();
                }
            });
        });
    </script>
</body>
</html>

